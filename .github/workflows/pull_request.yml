name: Continuous Sync from DevOpsProject to Clinic-token-system

on:
  schedule:
    # Runs at midnight every day
    - cron: '0 0 * * *'
  workflow_dispatch: # Allows manual trigger

jobs:
  sync_files:
    runs-on: ubuntu-latest

    steps:
    # Step 1: Checkout the SampleProjects repository (this repository) on the main branch
    - name: Checkout Target Repo (SampleProjects)
      uses: actions/checkout@v2
      with:
        persist-credentials: false # Disable so we can switch to the source repo
        fetch-depth: 0 # Fetch full history for better commit handling
        ref: main # Checkout the main branch

    # Step 2: Pull latest changes from the main branch
    - name: Pull Latest Changes from Main Branch
      run: |
        git pull origin main

    # Step 3: Remove submodule configuration (if exists)
    - name: Remove Submodule Configuration (if exists)
      run: |
        if [ -d "Clinic-token-system" ] && git submodule status | grep -q "Clinic-token-system"; then
          echo "Submodule 'Clinic-token-system' detected. Removing it..."
          git submodule deinit -f Clinic-token-system || true
          git rm -f Clinic-token-system || true
          rm -rf .git/modules/Clinic-token-system || true
          git commit -m "Remove submodule Clinic-token-system" || true
        else
          echo "No submodule detected for 'Clinic-token-system'. Proceeding..."
        fi

    # Step 4: Remove .gitmodules entry for Clinic-token-system (if exists)
    - name: Remove .gitmodules entry for Clinic-token-system (if exists)
      run: |
        if [ -f ".gitmodules" ]; then
          echo "Checking .gitmodules for Clinic-token-system..."
          if grep -q "Clinic-token-system" .gitmodules; then
            echo "Removing Clinic-token-system reference from .gitmodules"
            sed -i '/Clinic-token-system/d' .gitmodules
            git add .gitmodules
            git commit -m "Remove Clinic-token-system from .gitmodules" || true
          else
            echo "No submodule reference found in .gitmodules."
          fi
        else
          echo ".gitmodules file does not exist."
        fi

    # Step 5: Authenticate using the PAT to allow fetching from DevOpsProject
    - name: Set up Authentication
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "github-actions[bot]@users.noreply.github.com"
        git remote add source https://${{ secrets.GH_PAT }}@github.com/ashiksp1994/DevOpsProject.git

    # Step 6: Fetch DevOpsProject repository and sync files into Clinic-token-system folder
    - name: Fetch and Sync DevOpsProject Repo
      run: |
        # Fetch all files from DevOpsProject repository
        git fetch source
        git checkout source/main -- .

        # Sync the entire DevOpsProject contents into the Clinic-token-system folder in SampleProjects
        mkdir -p Clinic-token-system
        rsync -av --delete --progress ./ Clinic-token-system/ --exclude Clinic-token-system/ # Sync files into folder and delete files not present in DevOpsProject

    # Step 7: Commit the changes if there are any
    - name: Commit Changes
      run: |
        git add Clinic-token-system/
        if git diff-index --quiet HEAD; then
          echo "No changes to commit"
        else
          git commit -m "Sync files from DevOpsProject to Clinic-token-system"
        fi

    # Step 8: Push changes to the main branch of SampleProjects
    - name: Push Changes to Main Branch
      env:
        GH_PAT: ${{ secrets.GH_PAT }} # Use PAT for pushing
      run: |
        git push https://${{ secrets.GH_PAT }}@github.com/ashiksp1994/SampleProjects.git main || echo "No changes to push"
